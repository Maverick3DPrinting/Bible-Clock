<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tag - CRITICAL for full-screen (standalone) launch on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Always On Bible Display (ESV)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Always On Display Aesthetic - Black background, minimalist */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #d1d5db; /* Light gray for main text */
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            overflow: hidden; /* Prevent scrolling */
        }
        .container {
            width: 95%;
            max-width: 600px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .time-display {
            font-size: 5rem;
            font-weight: 700;
            color: #10b981; /* Emerald green accent */
            line-height: 1;
        }
        .verse-reference {
            color: #6ee7b7; /* Lighter green for reference */
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .verse-text {
            font-size: 1.5rem;
            line-height: 1.7;
            text-shadow: 0 0 5px rgba(209, 213, 219, 0.2);
            min-height: 6rem; /* Ensure stability while loading */
        }
        /* Loading spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Mobile optimization */
        @media (max-width: 640px) {
            .time-display {
                font-size: 4rem;
            }
            .verse-text {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>

<div class="container rounded-xl">
    <div id="time-display" class="time-display transition-opacity duration-1000">--:--</div>
    
    <!-- Content container, hidden while loading -->
    <div id="content-area">
        <div id="verse-reference" class="verse-reference"></div>
        <div id="verse-text" class="verse-text"></div>
    </div>

    <!-- Loading spinner, shown while fetching data -->
    <div id="loading-spinner" class="mt-4 hidden">
        <div class="spinner"></div>
        <p class="mt-2 text-sm text-green-400">Finding John H:M (ESV) using Gemini...</p>
    </div>
</div>

<script type="module">
    // --- NOTE ON EXTERNAL DEPLOYMENT ---
    // The Firebase imports below are ONLY necessary for the Canvas environment's security.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBAL CONSTANTS AND DOM ELEMENTS ---
    const timeDisplayEl = document.getElementById('time-display');
    const verseReferenceEl = document.getElementById('verse-reference');
    const verseTextEl = document.getElementById('verse-text');
    const loadingSpinnerEl = document.getElementById('loading-spinner');
    const contentAreaEl = document.getElementById('content-area');
    
    const BOOK_NAME = "John";
    const TRANSLATION = "ESV";
    const API_MODEL = "gemini-2.5-flash-preview-09-2025";
    
    // !!! CRITICAL for external use: You must set your own Gemini API Key here or the fetches will fail !!!
    // This key is currently set by the user in their GitHub code.
    const API_KEY = "AIzaSyC9ViqJivgZCDRBN3dxDIaPlH5R9fILSgw"; // Placeholder
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;

    let updateInterval; 

    // --- ENVIRONMENT-SPECIFIC AUTHENTICATION (Ignored in public deployment) ---
    async function authenticate() {
        if (typeof __app_id === 'undefined') { return; }
        
        try {
            const appId = __app_id;
            const firebaseConfig = JSON.parse(__firebase_config);
            const db = initializeApp(firebaseConfig);
            const auth = getAuth(db);
            const initialAuthToken = __initial_auth_token;

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Firebase Auth failed (expected if running externally):", error);
        }
    }

    /**
     * Implements exponential backoff for retrying API calls.
     */
    async function retryWithBackoff(fn, maxRetries = 5) {
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                return await fn();
            } catch (error) {
                if (attempt === maxRetries - 1) {
                    throw error;
                }
                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    /**
     * Formats the time into a standard 12-hour clock display.
     */
    function formatTime(hour24, minute) {
        const hour12 = hour24 % 12 === 0 ? 12 : hour24 % 12; 
        const ampm = hour24 < 12 ? 'AM' : 'PM';
        const minutePadded = minute.toString().padStart(2, '0');

        return {
            time: `${hour12}:${minutePadded}`,
            ampm: ampm
        };
    }

    /**
     * Calls the Gemini API to search for and retrieve the Bible verse text.
     */
    async function fetchVerseText(chapter, verse) {
        if (!API_KEY || API_KEY.includes("Placeholder")) {
            return "API Key Missing: Please insert your Gemini API Key in the script for verse lookup to work.";
        }
        
        const query = `Find the text for ${BOOK_NAME} ${chapter}:${verse} in the ${TRANSLATION} translation. If the verse does not exist, find the *last* available verse in that chapter and return it.`;
        
        const payload = {
            contents: [{ parts: [{ text: query }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: "You are a specialized Bible knowledge engine. When asked for a verse, provide *only* the verse text and nothing else, ensuring accuracy using Google Search." }]
            }
        };

        const fetchFn = async () => {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            let cleanedText = text || `Could not find a valid response for ${BOOK_NAME} ${chapter}:${verse}.`;
            cleanedText = cleanedText.replace(/^['"]|['"]$/g, '').trim(); 
            
            return cleanedText;
        };

        try {
            return await retryWithBackoff(fetchFn);
        } catch (error) {
            console.error("Gemini API error after retries:", error);
            return `Verse lookup failed: ${error.message}`;
        }
    }

    /**
     * Main function to update the display content.
     */
    async function updateDisplay() {
        const now = new Date();
        const hour24 = now.getHours();
        const minute = now.getMinutes();
        const chapterNumber = hour24 % 12 === 0 ? 12 : hour24 % 12;
        const verseNumber = minute === 0 ? 1 : minute; 

        const formattedTime = formatTime(hour24, minute);
        const reference = `${BOOK_NAME} ${chapterNumber}:${verseNumber} (${TRANSLATION})`;
        
        // 1. Update time and reference immediately
        timeDisplayEl.innerHTML = `
            ${formattedTime.time} 
            <span class="text-3xl font-normal text-gray-400 align-top">${formattedTime.ampm}</span>
        `;
        verseReferenceEl.textContent = reference;
        verseTextEl.textContent = "Loading..."; 
        
        // 2. Show loading state
        contentAreaEl.classList.remove('hidden');
        loadingSpinnerEl.classList.remove('hidden');

        // 3. Fetch the verse text
        const verseText = await fetchVerseText(chapterNumber.toString(), verseNumber.toString());

        // 4. Update UI with fetched text and hide spinner
        verseTextEl.textContent = verseText.trim();
        loadingSpinnerEl.classList.add('hidden');

        // 5. Set up the next update interval
        const timeToWait = 60000 - (new Date().getSeconds() * 1000 + new Date().getMilliseconds());
        
        if (updateInterval) {
            clearTimeout(updateInterval);
        }
        
        updateInterval = setTimeout(() => {
            updateDisplay(); 
            updateInterval = setInterval(updateDisplay, 60000); 
        }, timeToWait);
    }
    
    // --- INITIALIZATION ---
    function initDisplay() {
        updateDisplay();
    }

    window.onload = initDisplay;

</script>
</body>
</html>

